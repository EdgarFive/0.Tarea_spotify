<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Spotify Top Tracks - Cola de Canciones</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #1DB954; }
    button { margin-right: 10px; padding: 10px; }
  </style>
</head>
<body>
  <h1>Spotify Top Tracks - Cola de Canciones</h1>
  <div id="loginMessage"></div>
  <button id="fetchTracks">Obtener Top 10 Canciones</button>
  <button id="playNext">Reproducir Siguiente Canción</button>
  <div id="queueDisplay"></div>

  <script>
    // Función para obtener parámetros de la URL
    function getQueryVariable(variable) {
      var query = window.location.search.substring(1);
      var vars = query.split('&');
      for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split('=');
        if (pair[0] === variable) { return decodeURIComponent(pair[1]); }
      }
      return null;
    }

    // Obtenemos el token de la query string (si existe)
    const SPOTIFY_TOKEN = getQueryVariable("access_token");

    // Si no se encuentra el token, mostramos un mensaje con enlace para iniciar sesión
    if (!SPOTIFY_TOKEN) {
      document.getElementById("loginMessage").innerHTML = `<p>No estás autenticado. <a href="/login">Inicia sesión con Spotify</a></p>`;
    }

    // URL del endpoint de Spotify para obtener Top Tracks
    const API_URL = "https://api.spotify.com/v1/me/top/tracks?limit=10";

    // ================================
    // IMPLEMENTACIÓN DE LA COLA (FIFO)
    // ================================
    class Queue {
      constructor() {
        this.items = [];
      }
      // Agrega una canción al final de la cola.
      enqueue(cancion) {
        this.items.push(cancion);
      }
      // Elimina y devuelve la canción más antigua de la cola.
      dequeue() {
        return this.items.shift();
      }
      // Devuelve el contenido actual de la cola.
      mostrar() {
        return this.items;
      }
      // Verifica si la cola está vacía.
      isEmpty() {
        return this.items.length === 0;
      }
    }

    // Instancia de la cola
    let songQueue = new Queue();

    // ================================
    // OBTENER TOP 10 CANCIONES DESDE SPOTIFY
    // ================================
    async function fetchTopTracks() {
      if (!SPOTIFY_TOKEN) {
        alert("Primero debes autenticarte.");
        return;
      }
      try {
        const response = await fetch(API_URL, {
          headers: {
            'Authorization': `Bearer ${SPOTIFY_TOKEN}`
          }
        });
        const data = await response.json();
        // Se asume que data.items es el array con las canciones
        data.items.forEach(track => {
          // Almacenamos la información mínima de la canción: nombre y enlace a Spotify.
          const cancion = {
            titulo: track.name,
            enlace: track.external_urls.spotify
          };
          songQueue.enqueue(cancion);
        });
        updateQueueDisplay();
      } catch (error) {
        console.error("Error al obtener las canciones:", error);
      }
    }

    // Actualiza la visualización de la cola en la interfaz.
    function updateQueueDisplay() {
      const display = document.getElementById("queueDisplay");
      display.innerHTML = "<h2>Cola de Canciones:</h2>";
      if (songQueue.isEmpty()) {
        display.innerHTML += "<p>La cola está vacía.</p>";
        return;
      }
      const list = document.createElement("ul");
      songQueue.mostrar().forEach((cancion, index) => {
        const item = document.createElement("li");
        item.innerHTML = `${index + 1}. ${cancion.titulo} - <a href="${cancion.enlace}" target="_blank">Escuchar</a>`;
        list.appendChild(item);
      });
      display.appendChild(list);
    }

    // ================================
    // SIMULACIÓN DE REPRODUCCIÓN (FIFO)
    // ================================
    function playNextSong() {
      if (songQueue.isEmpty()) {
        alert("No quedan canciones en la cola.");
        return;
      }
      const nextSong = songQueue.dequeue();
      alert("Reproduciendo: " + nextSong.titulo);
      updateQueueDisplay();
    }

    // ================================
    // EVENTOS DE INTERFAZ
    // ================================
    document.getElementById("fetchTracks").addEventListener("click", fetchTopTracks);
    document.getElementById("playNext").addEventListener("click", playNextSong);
  </script>
</body>
</html>
